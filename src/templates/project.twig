{% extends 'layout.twig' %}

{% from _self import commit_block %}

{% block title 'Project ' ~ project %}

{% block content %}
    <div id="back"><a href="{{ path('projects') }}">&laquo; Projects</a></div>

    <h1>
        <a href="{{ path('project', { 'slug': project.slug }) }}">
            Sismo &mdash; {{ project.shortname }}
            {% if project.subname %}<small> ({{ project.subname }})</small>{% endif %}
        </a>
    </h1>

    {% if not commit %}
        <p id="error">Never built yet.</p>
    {% else %}
        <div class="clearfix {{ commit.statuscode }}" id="build">{{ commit_block(commit) }}</div>

        {% if commit.coverage and commits is defined and 0 < commits|length %}
            <div id="coverage">
                <ul class="timeline">
                    <li class="current">
                        <a href="{{ path('commit', { 'slug': commit.project.slug, 'sha': commit.sha }) }}" »
                        title="{{ commit.sha }} @ {{ commit.date|date('H:i - jS F, Y') }}">
                            <span class="label">{{ commit.coverage }}%</span>
                            <span class="count" style="height: {{ commit.coverage }}%">{{ commit.coverage }}</span>
                        </a>
                    </li>
                {% for cmt in commits %}
                    <li>
                        <a href="{{ path('commit', { 'slug': cmt.project.slug, 'sha': cmt.sha }) }}" »
                        title="{{ cmt.sha }} @ {{ cmt.date|date('H:i - jS F, Y') }}">
                            <span class="label">{{ cmt.coverage }}%</span>
                            <span class="count" style="height: {{ cmt.coverage }}%">{{ cmt.coverage }}</span>
                        </a>
                    </li>
                {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if commit.isbuilt %}
            <div id="output">
                <pre>{{ commit.output ? ansi_to_html.convert(commit.output)|raw : 'No output' }}</pre>
            </div>
        {% endif %}

        {% if commits is defined and commits %}
            <h1>Build History</h1>
            <ul id="builds">
                {% for commit in commits %}
                    <li class="{{ commit.statuscode }} cf">{{ commit_block(commit) }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endif %}
{% endblock %}

{% macro commit_block(commit) %}
    <ul class="meta meta--right">
        <li><a href="{{ path('commit', { 'slug': commit.project.slug, 'sha': commit.sha }) }}"><i class="fa fa-link" aria-hidden="true"></i></a></li>
        <li>{{ _self.commit_link(commit) }}</li>
    </ul>
    <h2>
        {{ commit.message }}
    </h2>
    <div class="meta meta--right">
        coverage <em>{{ commit.coverage }}%</em>
    </div>
    <div class="meta">
        by <em>{{ commit.author }}</em> on <em>{{ commit.date|date('j M Y H:i') }}</em>
    </div>
{% endmacro %}

{% macro commit_link(commit) %}
    {% if not commit.project.urlpattern %}
        #{{ commit.shortsha }}
    {% else %}
        <a href="{{ commit.project.urlpattern|replace({'%commit%': commit.sha }) }}" target="_blank"><i class="fa fa-github" aria-hidden="true"></i></a>
    {% endif %}
{% endmacro %}
